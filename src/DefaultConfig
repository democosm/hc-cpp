# vim: ft=make
#***************************
# Common make configuration
#***************************

# Determine package name and type
PKGNAME = $(shell basename `pwd`)
PKGTYPE = $(subst /$(PKGNAME),,$(subst $(PROJBASEDIR)/src/,,$(shell pwd)))

# Determine Host OS
UNAME_S := $(shell uname -s)

# Add target OS library to link libraries
LINKLIBS += $(TGTOS)

# Destination directory setup
TGTDIR = $(TGTPROC)$(TGTOS)$(TGTBUILD)
DEPDSTDIR = $(PROJBASEDIR)/dst/$(TGTDIR)/$(PKGTYPE)/$(PKGNAME)/dep
OBJDSTDIR = $(PROJBASEDIR)/dst/$(TGTDIR)/$(PKGTYPE)/$(PKGNAME)/obj
LIBDSTDIR = $(PROJBASEDIR)/dst/$(TGTDIR)/lib
APPDSTDIR = $(PROJBASEDIR)/dst/$(TGTDIR)/app
TESTDSTDIR = $(PROJBASEDIR)/dst/$(TGTDIR)/test
BINDSTDIR = $(PROJBASEDIR)/dst/$(TGTDIR)/bin

# Create source file list if not already defined
SRCLIST ?= $(wildcard *.s *.c *.cc)

# Create dependency file list
DEPLIST = $(addprefix $(DEPDSTDIR)/,$(addsuffix .dep,$(SRCLIST)))

# Create object file list
OBJLIST = $(addprefix $(OBJDSTDIR)/,$(addsuffix .o,$(SRCLIST)))

# Create archive list
ARLIST = $(addsuffix .a, $(addprefix $(LIBDSTDIR)/lib, $(LINKLIBS)))

# Create library list
LIBLIST = $(addprefix -l, $(LINKLIBS))

# Variables used to build for different targets
ifeq ($(TGTPROC), $(shell uname -m))
 AS = as
 CC = gcc
 CXX = g++
 AR = ar
 LD = ld
 OBJCOPY = objcopy
 ASFLAGS =
 CFLAGS = \
  -Wall \
  -I$(PROJBASEDIR)/src/lib/bus \
  -I$(PROJBASEDIR)/src/lib/common \
  -I$(PROJBASEDIR)/src/lib/drv \
  -I$(PROJBASEDIR)/src/lib/gtest \
  -I$(PROJBASEDIR)/src/lib/hc \
  -I$(PROJBASEDIR)/src/lib/$(TGTOS)
 CXXFLAGS = $(CFLAGS)
 ARFLAGS =
 LDFLAGS = -L$(LIBDSTDIR)
 STDLIBLIST = \
  -lpthread \
  -lssl \
  -lcrypto

 # OSX doesn't support rt library
 ifneq ($(UNAME_S),Darwin)
  STDLIBLIST += \
   -lrt
 else
  # OSX has openssl in a differnt location
  CFLAGS += -I/usr/local/opt/openssl/include
  LDFLAGS += -L/usr/local/opt/openssl/lib
 endif

endif #TGTPROC

# Special options for special builds
ifeq ($(TGTBUILD), dbg)
 ASFLAGS += -g --defsym DEBUG=1
 CFLAGS += -g -DDEBUG
 CXXFLAGS += -g -DDEBUG
endif #TGTBUILD
